#!/usr/bin/env bash

set -euo pipefail

if [[ -z ${1:-} || ${1:-} == "CNCLD" ]]; then
  echo "Usage: dotfiles-theme-set <theme-name>"
  exit 1
fi

THEMES_DIR="$HOME/.config/dotfiles/themes"
CURRENT_THEME_DIR="$HOME/.config/dotfiles/current/theme"

THEME_NAME="$(echo "$1" | sed -E 's/<[^>]+>//g' | tr '[:upper:]' '[:lower:]' | tr ' ' '-')"
THEME_PATH="$THEMES_DIR/$THEME_NAME"

if [[ ! -d "$THEME_PATH" ]]; then
  echo "Theme '$THEME_NAME' does not exist in $THEMES_DIR"
  exit 1
fi

mkdir -p "$(dirname "$CURRENT_THEME_DIR")"
ln -nsf "$THEME_PATH" "$CURRENT_THEME_DIR"

# Apply Hypr theme: link color files if provided
if [[ -f "$CURRENT_THEME_DIR/hypr/hyprland.colors.conf" ]]; then
  mkdir -p "$HOME/.config/hypr/hyprland"
  ln -snf "$CURRENT_THEME_DIR/hypr/hyprland.colors.conf" "$HOME/.config/hypr/hyprland/colors.conf"
fi

if [[ -f "$CURRENT_THEME_DIR/hypr/hyprlock.colors.conf" ]]; then
  mkdir -p "$HOME/.config/hypr/hyprlock"
  ln -snf "$CURRENT_THEME_DIR/hypr/hyprlock.colors.conf" "$HOME/.config/hypr/hyprlock/colors.conf"
fi

# Apply Hyprpanel theme stylesheet if present
if [[ -f "$CURRENT_THEME_DIR/hyprpanel/modules.scss" ]]; then
  mkdir -p "$HOME/.config/hyprpanel"
  ln -snf "$CURRENT_THEME_DIR/hyprpanel/modules.scss" "$HOME/.config/hyprpanel/modules.scss"
fi

# Optionally set a background if present
if compgen -G "$CURRENT_THEME_DIR/backgrounds/*" > /dev/null; then
  first_bg="$(ls -1 "$CURRENT_THEME_DIR/backgrounds" | sort | head -n1)"
  if [[ -n "$first_bg" ]]; then
    ln -snf "$CURRENT_THEME_DIR/backgrounds/$first_bg" "$HOME/.config/background"
  fi
fi

# Reload/notify
command -v hyprctl >/dev/null 2>&1 && hyprctl reload || true
command -v notify-send >/dev/null 2>&1 && notify-send "Theme switched" "dotfiles theme: $THEME_NAME" -t 2000 || true


