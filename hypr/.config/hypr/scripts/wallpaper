#!/usr/bin/env bash
set -euo pipefail

DIR="$HOME/Pictures/wallpapers/nord-background"
CONF="$HOME/.config/hyprpaper/hyprpaper.conf"

monitors() { hyprctl monitors | awk '/^Monitor /{gsub(/[":]/, "", $2); print $2}'; }

apply_all() {
  local wp="$1"
  hyprctl hyprpaper preload "$wp" >/dev/null 2>&1 || true
  for m in $(monitors); do
    hyprctl hyprpaper wallpaper "$m,$wp" >/dev/null 2>&1 || true
  done
  mkdir -p "$(dirname "$CONF")"
  {
    printf 'preload = %s\n' "$wp"
    for m in $(monitors); do printf 'wallpaper = %s,%s\n' "$m" "$wp"; done
    printf 'splash = false\n'
  } >"$CONF"
}

cmd_random() {
  mapfile -t pics < <(find "$DIR" -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.webp' \))
  [ ${#pics[@]} -gt 0 ] || exit 1
  local pick=${pics[RANDOM % ${#pics[@]}]}
  apply_all "$pick"
}

cmd_sync() {
  local wp
  wp=$(awk -F'= ' '/^preload/{print $2; exit}' "$CONF" 2>/dev/null || true)
  [ -n "${wp:-}" ] || exit 0
  apply_all "$wp"
}

case "${1:-}" in
  random) cmd_random ;;
  sync)   cmd_sync ;;
  set)    apply_all "${2:?path}" ;;
  *)      echo "usage: $0 {random|sync|set <file>}"; exit 1 ;;
esac
