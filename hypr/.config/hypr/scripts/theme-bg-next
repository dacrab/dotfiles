#!/bin/bash

set -euo pipefail

BACKGROUNDS_DIR="$HOME/.config/themes/current/theme/backgrounds"
CURRENT_BACKGROUND_LINK="$HOME/.config/themes/current/background"

mkdir -p "$(dirname "$CURRENT_BACKGROUND_LINK")"

mapfile -d '' -t BACKGROUNDS < <(find "$BACKGROUNDS_DIR" -type f -print0 | sort -z)
TOTAL=${#BACKGROUNDS[@]}

if (( TOTAL == 0 )); then
  notify-send "No theme backgrounds found" -t 2000 2>/dev/null || true
  exit 0
fi

if [[ -L "$CURRENT_BACKGROUND_LINK" ]]; then
  CURRENT_BACKGROUND=$(readlink "$CURRENT_BACKGROUND_LINK")
else
  CURRENT_BACKGROUND=""
fi

INDEX=-1
for i in "${!BACKGROUNDS[@]}"; do
  if [[ "${BACKGROUNDS[$i]}" == "$CURRENT_BACKGROUND" ]]; then
    INDEX=$i
    break
  fi
done

if (( INDEX == -1 )); then
  NEW_BACKGROUND="${BACKGROUNDS[0]}"
else
  NEXT_INDEX=$(((INDEX + 1) % TOTAL))
  NEW_BACKGROUND="${BACKGROUNDS[$NEXT_INDEX]}"
fi

ln -nsf "$NEW_BACKGROUND" "$CURRENT_BACKGROUND_LINK"

# Apply via existing wallpaper script which also regenerates colors and reloads
"$HOME/.config/hypr/scripts/wallpaper" set "$CURRENT_BACKGROUND_LINK"


